<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,fileCache," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="iOS文件缓存Plist文件可以直接映射为NSDictionary和NSArray，是使用非常广泛了一种文件格式。 iOS项目开发过程中我们要用Plist文件保存一些界面的开启次数、判断用户是否是第一次进入界面、保存用户的一些配置信息等等。  接下来我们先聊聊Plist文件读写可能遇到的一些问题。 1、读写文件效率问题 iOS对于文件的读写速度优化是非常好的，在iPhone7上测试的一些几百Kb的">
<meta name="keywords" content="iOS,fileCache">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS文件缓存">
<meta property="og:url" content="https://ctinusdev.github.io/2017/07/29/FileCache/index.html">
<meta property="og:site_name" content="ctinusDev&#39;s Blog">
<meta property="og:description" content="iOS文件缓存Plist文件可以直接映射为NSDictionary和NSArray，是使用非常广泛了一种文件格式。 iOS项目开发过程中我们要用Plist文件保存一些界面的开启次数、判断用户是否是第一次进入界面、保存用户的一些配置信息等等。  接下来我们先聊聊Plist文件读写可能遇到的一些问题。 1、读写文件效率问题 iOS对于文件的读写速度优化是非常好的，在iPhone7上测试的一些几百Kb的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ctinusdev.github.io/images/FileCache/image1.jpg">
<meta property="og:image" content="https://ctinusdev.github.io/images/FileCache/image2.jpg">
<meta property="og:image" content="https://ctinusdev.github.io/images/FileCache/image3.jpg">
<meta property="og:updated_time" content="2017-07-29T09:25:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS文件缓存">
<meta name="twitter:description" content="iOS文件缓存Plist文件可以直接映射为NSDictionary和NSArray，是使用非常广泛了一种文件格式。 iOS项目开发过程中我们要用Plist文件保存一些界面的开启次数、判断用户是否是第一次进入界面、保存用户的一些配置信息等等。  接下来我们先聊聊Plist文件读写可能遇到的一些问题。 1、读写文件效率问题 iOS对于文件的读写速度优化是非常好的，在iPhone7上测试的一些几百Kb的">
<meta name="twitter:image" content="https://ctinusdev.github.io/images/FileCache/image1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ctinusdev.github.io/2017/07/29/FileCache/"/>





  <title>iOS文件缓存 | ctinusDev's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ctinusDev's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Development  Sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ctinusdev.github.io/2017/07/29/FileCache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ctinusDev">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ctinusDev's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS文件缓存</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-29T12:30:17+08:00">
                2017-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/07/29/FileCache/" class="leancloud_visitors" data-flag-title="iOS文件缓存">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="iOS文件缓存"><a href="#iOS文件缓存" class="headerlink" title="iOS文件缓存"></a>iOS文件缓存</h1><p>Plist文件可以直接映射为NSDictionary和NSArray，是使用非常广泛了一种文件格式。 iOS项目开发过程中我们要用Plist文件保存一些界面的开启次数、判断用户是否是第一次进入界面、保存用户的一些配置信息等等。</p>
<hr>
<p>接下来我们先聊聊Plist文件读写可能遇到的一些问题。</p>
<h2 id="1、读写文件效率问题"><a href="#1、读写文件效率问题" class="headerlink" title="1、读写文件效率问题"></a>1、读写文件效率问题</h2><p> iOS对于文件的读写速度优化是非常好的，在iPhone7上测试的一些几百Kb的文件读写速度达都在十几毫秒左右，这样的效率在大多数情况下，基本不会对界面流程度造成影响。但是如果同时出现了较多次数的文件读写，特别是在主线程进行大量的文件读写操作，就可能会造成一些界面卡顿的情况。例如：</p>
<p> 一个界面Push的时候，需要读写十个状态，这时界面的卡顿时间就可能有100多毫秒，按照1秒60帧的最优帧率计算（也就是16.7毫秒左右一帧），这时可能要丢失10帧左右。界面流程度就严重下降了。</p>
<h2 id="2、多线程读写的问题误解"><a href="#2、多线程读写的问题误解" class="headerlink" title="2、多线程读写的问题误解"></a>2、多线程读写的问题误解</h2><p>我们来看看NSDictionary自带的writeToFile方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)writeToFile:(<span class="built_in">NSString</span> *)path atomically:(<span class="built_in">BOOL</span>)useAuxiliaryFile;</div></pre></td></tr></table></figure>
<p>path：指定了写入的文件路径<br>useAuxiliaryFile：则用来控制是否要原子写入。<br>下面是官方文档对useAuxiliaryFile的解释：</p>
<blockquote>
<p>A flag that specifies whether the file should be written atomically.<br>If flag is YES, the dictionary is written to an auxiliary file, and then the auxiliary file is renamed to path. If flag is NO, the dictionary is written directly to path. The YES option guarantees that path, if it exists at all, won’t be corrupted even if the system should crash during writing.</p>
</blockquote>
<p>大意：如果标志为YES，则将字典写入辅助文件，然后将辅助文件重命名到path 。如果标志为NO，则字典直接写入path。 YES选项保证路径（如果存在）将不会被破坏，即使系统在写入时应该崩溃。<br>简单的说就是，旧内容不会改变，除非新内容写入结束。</p>
<p>逻辑示意图如下：<br><img src="/images/FileCache/image1.jpg" alt=""></p>
<p>但是这里的useAuxiliaryFile和属性的atomic是完全不同的两个概念。属性的atomic实际上是给属性加锁，同时只能有一个线程在写入，而useAuxiliaryFile只是用来控制文件的完整性，多个线程是可以同时进行写操作的，只不过都是写入临时文件，谁写的快谁就先写入到真正文件path路径，出现的问题显而易见，很可能最终保存的是一份过期的脏数据。<br>逻辑示意图如下：</p>
<p><img src="/images/FileCache/image2.jpg" alt=""></p>
<h2 id="3、解决方案"><a href="#3、解决方案" class="headerlink" title="3、解决方案"></a>3、解决方案</h2><p>为了处理好上面两个问题，这里采用的文件缓存逻辑。大致步骤：</p>
<p>1、使用了两个队列控制：写文件队列、读写缓存队列。<br>2、为了保证文件的完整性和先进先出，写文件队列设计为同步队列，保证同时只有一个缓存在写文件。<br>3、读写缓存队列因为涉及多线程的读写使用了异步队列，同时为了保证写缓存的同时不能有读文件的操作（因为可能读到的是脏数据，并不是最新的），使用了GCD的barrier进行控制</p>
<p>逻辑示意图入下：<br><img src="/images/FileCache/image3.jpg" alt=""></p>
<p>看看dispatch_barrier_async函数原型：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> dispatch_barrier_async(<span class="built_in">dispatch_queue_t</span> queue, dispatch_block_t block);</div></pre></td></tr></table></figure>
<p>看看官方对barrier类型函数的解释</p>
<p>/*!</p>
<ul>
<li>@functiongroup Dispatch Barrier API</li>
<li>The dispatch barrier API is a mechanism for submitting barrier blocks to a</li>
<li>dispatch queue, analogous to the dispatch_async()/dispatch_sync() API.</li>
<li>It enables the implementation of efficient reader/writer schemes.</li>
<li>Barrier blocks only behave specially when submitted to queues created with</li>
<li>the DISPATCH_QUEUE_CONCURRENT attribute; on such a queue, a barrier block</li>
<li>will not run until all blocks submitted to the queue earlier have completed,</li>
<li>and any blocks submitted to the queue after a barrier block will not run</li>
<li>until the barrier block has completed.</li>
<li>When submitted to a a global queue or to a queue not created with the</li>
<li>DISPATCH_QUEUE_CONCURRENT attribute, barrier blocks behave identically to</li>
<li>blocks submitted with the dispatch_async()/dispatch_sync() API.<br>*/</li>
</ul>
<p>barrier能够实现高效的读/写方案,barrier中的bolck代码块需要等在barrier之前添加到队列中的代码块执行完才开始执行，同时只有barrier中的bolck代码块在执行完之前，其他代码块不会执行。</p>
<p>如果将barrier提交到一个全局队列或不是使用 <code>DISPATCH_QUEUE_CONCURRENT</code>创建的队列，barrier块的行为与<code>dispatch_async()</code> / <code>dispatch_sync()</code>API是相同的。</p>
<p>下面看些详细代码<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FSFileCache</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FSFileCache</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableDictionary</span> *cacheDict;</div><div class="line">    <span class="built_in">dispatch_queue_t</span> synQueue;</div><div class="line">    <span class="built_in">dispatch_queue_t</span> writeQueue;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(<span class="keyword">instancetype</span>) shareInstance</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> FSFileCache *fileCache = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (fileCache == <span class="literal">nil</span>)</div><div class="line">    &#123;</div><div class="line">        fileCache = [[FSFileCache alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> fileCache;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(didReceivememoryWarning) name:<span class="built_in">UIApplicationDidReceiveMemoryWarningNotification</span> object:<span class="literal">nil</span>];</div><div class="line">        </div><div class="line">        cacheDict = [<span class="built_in">NSMutableDictionary</span> dictionaryWithCapacity:<span class="number">1.0</span>];</div><div class="line">        synQueue = dispatch_queue_create(<span class="string">"com.FSFile.synQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">        writeQueue = dispatch_queue_create(<span class="string">"com.FSFile.write"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)didReceivememoryWarning</div><div class="line">&#123;</div><div class="line">    dispatch_barrier_async(synQueue, ^&#123;</div><div class="line">        [cacheDict removeAllObjects];</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">id</span>) objForKey:(<span class="built_in">NSString</span> *)key withPath:(<span class="built_in">NSString</span> *)path</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> start = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    <span class="built_in">NSAssert</span>(key!=<span class="literal">nil</span>, <span class="literal">nil</span>);</div><div class="line">    <span class="built_in">NSAssert</span>(path!=<span class="literal">nil</span>, <span class="literal">nil</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (key == <span class="literal">nil</span> || path == <span class="literal">nil</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __block <span class="keyword">id</span> obj = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">dispatch_sync</span>(synQueue, ^&#123;</div><div class="line">        <span class="built_in">NSMutableDictionary</span> *fileDic = [<span class="keyword">self</span> getAndCacheFileWithPath:path autoCreateFile:<span class="literal">NO</span>];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> ([fileDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]])</div><div class="line">        &#123;</div><div class="line">            obj = fileDic[key];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> end = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"get obj forKey:%@ time : %fms"</span>, key,(end-start)*<span class="number">1000</span>);</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="built_in">BOOL</span>) setObj:(<span class="keyword">id</span>)obj forKey:(<span class="built_in">NSString</span> *)key withPath:(<span class="built_in">NSString</span> *)path</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> start = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line"></div><div class="line">    <span class="built_in">NSAssert</span>(key!=<span class="literal">nil</span>, <span class="literal">nil</span>);</div><div class="line">    <span class="built_in">NSAssert</span>(path!=<span class="literal">nil</span>, <span class="literal">nil</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (key == <span class="literal">nil</span> || path == <span class="literal">nil</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dispatch_barrier_async(synQueue, ^&#123;</div><div class="line">        <span class="built_in">NSMutableDictionary</span> *fileDic = [<span class="keyword">self</span> getAndCacheFileWithPath:path autoCreateFile:<span class="literal">YES</span>];</div><div class="line">        <span class="keyword">if</span> ([fileDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">            fileDic[key] = obj;</div><div class="line">            [<span class="keyword">self</span> saveFile:path withDict:fileDic];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> end = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"set obj forKey %@ time : %fms"</span>, key,(end-start)*<span class="number">1000</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="built_in">NSMutableDictionary</span> *)getAndCacheFileWithPath:(<span class="built_in">NSString</span> *)path autoCreateFile:(<span class="built_in">BOOL</span>)autoCreateFile</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSAssert</span>(path!=<span class="literal">nil</span>, <span class="literal">nil</span>);</div><div class="line">    <span class="keyword">if</span> (path == <span class="literal">nil</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span> *fileDict = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (cacheDict[path] &amp;&amp; [fileManager fileExistsAtPath:path])&#123;</div><div class="line">        fileDict = cacheDict[path];</div><div class="line">        <span class="keyword">return</span> fileDict;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([fileManager fileExistsAtPath:path]) &#123;</div><div class="line">        fileDict = [[<span class="built_in">NSDictionary</span> dictionaryWithContentsOfFile:path] mutableCopy];</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (autoCreateFile)&#123;</div><div class="line">        <span class="built_in">NSError</span> *error = [EntrysOperateHelper touchDirForFilePath:path];</div><div class="line">        <span class="keyword">if</span>(error) &#123;</div><div class="line">            <span class="built_in">NSLogToFile</span>(<span class="string">@"Warn: ************ create global stroage directory fail"</span>);</div><div class="line">        &#125;</div><div class="line"><span class="meta">#if(!TARGET_IPHONE_SIMULATOR)</span></div><div class="line">        <span class="built_in">NSDictionary</span> *attr = @&#123;<span class="built_in">NSFileProtectionKey</span>: <span class="built_in">NSFileProtectionCompleteUntilFirstUserAuthentication</span>&#125;;</div><div class="line"><span class="meta">#else</span></div><div class="line">        <span class="built_in">NSDictionary</span> *attr = <span class="literal">nil</span>;</div><div class="line"><span class="meta">#endif</span></div><div class="line">        <span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</div><div class="line">            <span class="keyword">if</span>([fileManager createFileAtPath:path contents:<span class="literal">nil</span> attributes:attr]) &#123;</div><div class="line">                fileDict = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//nothing</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (fileDict)&#123;</div><div class="line">        cacheDict[path] = fileDict;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> fileDict;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>) saveFile:(<span class="built_in">NSString</span> *)path withDict:(<span class="built_in">NSDictionary</span> *)dict</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSDictionary</span> *writeDict = [dict mutableCopy];</div><div class="line">    <span class="built_in">dispatch_async</span>(writeQueue, ^&#123;</div><div class="line">        <span class="built_in">BOOL</span> sucess = [writeDict writeToFile:path atomically:<span class="literal">YES</span>];</div><div class="line">        <span class="keyword">if</span> (!sucess) &#123;</div><div class="line">            <span class="built_in">NSLogToFile</span>(<span class="string">@"FSFileOperation saveObject %@ fail"</span>,writeDict);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="关于清空缓存策略"><a href="#关于清空缓存策略" class="headerlink" title="关于清空缓存策略"></a>关于清空缓存策略</h2><p>缓存的存储空间有限制，当缓存空间被用满时，如何保证有效提升命中率？这就由缓存清空策略来处理，设计适合自身数据特征的清空策略能有效提升命中率。常见的一般策略有：</p>
<h4 id="•-FIFO-first-in-first-out"><a href="#•-FIFO-first-in-first-out" class="headerlink" title="• FIFO(first in first out)"></a>• FIFO(first in first out)</h4><p>先进先出策略，最先进入缓存的数据在缓存空间不够的情况下（超出最大元素限制）会被优先被清除掉，以腾出新的空间接受新的数据。策略算法主要比较缓存元素的创建时间。在数据实效性要求场景下可选择该类策略，优先保障最新数据可用。</p>
<h4 id="•-LFU-less-frequently-used"><a href="#•-LFU-less-frequently-used" class="headerlink" title="• LFU(less frequently used)"></a>• LFU(less frequently used)</h4><p>最少使用策略，无论是否过期，根据元素的被使用次数判断，清除使用次数较少的元素释放空间。策略算法主要比较元素的hitCount（命中次数）。在保证高频数据有效性场景下，可选择这类策略。</p>
<h4 id="•-LRU-least-recently-used"><a href="#•-LRU-least-recently-used" class="headerlink" title="• LRU(least recently used)"></a>• LRU(least recently used)</h4><p>最近最少使用策略，无论是否过期，根据元素最后一次被使用的时间戳，清除最远使用时间戳的元素释放空间。策略算法主要比较元素最近一次被get使用时间。在热点数据场景下较适用，优先保证热点数据的有效性。<br>除此之外，还有一些简单策略比如：<br>• 根据过期时间判断，清理过期时间最长的元素；<br>• 根据过期时间判断，清理最近要过期的元素；<br>• 随机清理；<br>• 根据关键字（或元素内容）长短清理等。</p>
<p>这些策略不分好坏，主要看缓存的应用场景。</p>
<div class="note danger"><p><strong> 本文作者：</strong> ctinusdev<br><strong>本文链接：</strong> <a href="https://ctinusdev.github.io/2017/07/29/FileCache/">https://ctinusdev.github.io/2017/07/29/FileCache/</a><br><strong>转载请注明出处！</strong> </p>
</div>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="ctinusDev WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="ctinusDev Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/fileCache/" rel="tag"># fileCache</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/30/EffectiveObjcLearn/" rel="prev" title="Effective Objective-C 总结">
                Effective Objective-C 总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="ctinusDev" />
          <p class="site-author-name" itemprop="name">ctinusDev</p>
           
              <p class="site-description motion-element" itemprop="description">iOS Developer</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS文件缓存"><span class="nav-number">1.</span> <span class="nav-text">iOS文件缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、读写文件效率问题"><span class="nav-number">1.1.</span> <span class="nav-text">1、读写文件效率问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、多线程读写的问题误解"><span class="nav-number">1.2.</span> <span class="nav-text">2、多线程读写的问题误解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、解决方案"><span class="nav-number">1.3.</span> <span class="nav-text">3、解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于清空缓存策略"><span class="nav-number">1.4.</span> <span class="nav-text">关于清空缓存策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#•-FIFO-first-in-first-out"><span class="nav-number">1.4.0.1.</span> <span class="nav-text">• FIFO(first in first out)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#•-LFU-less-frequently-used"><span class="nav-number">1.4.0.2.</span> <span class="nav-text">• LFU(less frequently used)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#•-LRU-least-recently-used"><span class="nav-number">1.4.0.3.</span> <span class="nav-text">• LRU(least recently used)</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ctinusDev</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("z64DkEGmmRACgBQhankrR9CS-gzGzoHsz", "lEVwYGjtw9hocOO8l3Ycldiq");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
